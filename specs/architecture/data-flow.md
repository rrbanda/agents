# Data Flow & State Management

**Status**: As-Built (Extracted from current implementation)
**Last Updated**: 2024-12-15

---

## Overview

This document describes how data flows through the AI Hub application, from markdown files to rendered components, including state management patterns.

---

## Architecture Diagram

```
┌─────────────────┐
│ CONTENT SOURCE  │
└────────┬────────┘
         │
         ▼
┌──────────────────────────────────────────────┐
│ MARKDOWN FILES                               │
│ /data/slides/*.md                            │
│ - YAML frontmatter (title, id, number)       │
│ - Markdown sections (content, notes, refs)   │
└────────┬─────────────────────────────────────┘
         │
         │ (Build Time)
         ▼
┌──────────────────────────────────────────────┐
│ BUILD SCRIPT                                 │
│ scripts/generate-slides.mjs                  │
│ - Reads markdown files                       │
│ - Parses with gray-matter                    │
│ - Calls lib/slides.ts                        │
└────────┬─────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────┐
│ STATIC JSON                                  │
│ public/slides.json                           │
│ - Complete slide data (34 slides)            │
│ - Served as static asset                     │
└────────┬─────────────────────────────────────┘
         │
         │ (Runtime)
         ▼
┌──────────────────────────────────────────────┐
│ CLIENT DATA LOADER                           │
│ lib/slides-client.ts                         │
│ - Fetches /slides.json via fetch()           │
│ - Caches in memory                           │
│ - Returns Slide[] array                      │
└────────┬─────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────┐
│ PRESENTATION PAGE                            │
│ app/presentation/page.tsx                    │
│ - useState for slides, currentSlide, persona │
│ - useEffect to load slides on mount          │
│ - useEffect to sync with URL params          │
└────────┬─────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────┐
│ SLIDE ROUTER                                 │
│ components/slides/Slide.tsx                  │
│ - Switch on slide.number                     │
│ - Routes to special components               │
└────────┬─────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────┐
│ RENDERED COMPONENT                           │
│ components/slides/special/*Slide.tsx         │
│ - Receives slide data + persona prop         │
│ - Renders with animations                    │
│ - Uses diagrams if needed                    │
└──────────────────────────────────────────────┘
```

---

## Data Sources

### 1. Markdown Files (Content Source)

**Location**: `/data/slides/*.md`

**Count**: 30 markdown files (some slides use markdown, others are React-only components)

**Format**:
```markdown
---
id: "slide-01"
number: 1
title: "Agentic AI 101"
---

## Slide Content
Main content goes here...

## Speaker Notes
**Objective**: What the speaker should accomplish
**Duration**: 2 minutes
**Talking Points**:
- Point 1
- Point 2

## Visual Description
Describe the visuals for accessibility

## References
- Link 1
- Link 2
```

**Parsing**:
- `gray-matter` extracts YAML frontmatter + markdown body
- Body split by `## Slide Content`, `## Speaker Notes`, etc.
- Sections become properties on `SlideContent` object

---

### 2. Static JSON (Runtime Data)

**File**: `public/slides.json`

**Generated By**: `npm run generate-slides` (calls `scripts/generate-slides.mjs`)

**Size**: ~52KB

**Structure**:
```json
[
  {
    "id": "slide-01",
    "number": 1,
    "title": "Agentic AI 101",
    "content": {
      "title": "Agentic AI 101",
      "content": "Main content markdown...",
      "speakerNotes": "Speaker notes markdown...",
      "visualDescription": "Visual description...",
      "references": "References markdown..."
    },
    "part": "intro",
    "persona": ["all"]
  },
  // ... 33 more slides
]
```

**Access Pattern**:
- Client-side: `fetch('/ai-hub/slides.json')` (with basePath)
- No server-side access in production (static export)

---

## Data Loading Patterns

### Server-Side (Build Time Only)

**File**: `lib/slides.ts`

**Purpose**: Read markdown files, parse, generate data at build time

**Key Functions**:

```typescript
// Read all markdown files, return Slide[] array
export async function getAllSlides(): Promise<Slide[]>

// Get single slide by number
export async function getSlideData(slideNumber: number): Promise<Slide | null>

// Get metadata (total slides, parts/sections)
export async function getSlideMetadata(): Promise<SlideMetadata>
```

**Used By**:
- `scripts/generate-slides.mjs` (build script)
- Never used at runtime (static export)

**Implementation**:
```typescript
import fs from 'fs';
import path from 'path';
import matter from 'gray-matter';

export async function getAllSlides(): Promise<Slide[]> {
  const slidesDirectory = path.join(process.cwd(), 'data', 'slides');
  const fileNames = fs.readdirSync(slidesDirectory);

  const slides = fileNames
    .filter(file => file.endsWith('.md'))
    .map(fileName => {
      const filePath = path.join(slidesDirectory, fileName);
      const fileContents = fs.readFileSync(filePath, 'utf8');
      const { data, content } = matter(fileContents);

      // Parse sections from content
      const slideContent = parseSlideContent(content);

      return {
        id: data.id,
        number: data.number,
        title: data.title,
        content: slideContent,
        part: data.part,
        persona: data.persona || ['all'],
      };
    })
    .sort((a, b) => a.number - b.number);

  return slides;
}
```

---

### Client-Side (Runtime)

**File**: `lib/slides-client.ts`

**Purpose**: Fetch slides.json from static assets at runtime

**Key Functions**:

```typescript
// Fetch slides.json, return Slide[] array (cached)
export async function getAllSlidesClient(): Promise<Slide[]>

// Get metadata from client-side data
export async function getSlideMetadataClient(): Promise<SlideMetadata>
```

**Caching**:
```typescript
let cachedData: Slide[] | null = null;

export async function getAllSlidesClient(): Promise<Slide[]> {
  if (cachedData) return cachedData; // Return cache if available

  // Detect base path (localhost vs GitHub Pages)
  const basePath = window.location.hostname === 'localhost' ? '' : '/ai-hub';

  const response = await fetch(`${basePath}/slides.json`);
  if (!response.ok) {
    throw new Error('Failed to load slides');
  }

  cachedData = await response.json();
  return cachedData;
}
```

**Used By**:
- `app/presentation/page.tsx`
- `app/learn/101/page.tsx`
- Any page that displays slides

---

## State Management

### No Global State

The application **does not use**:
- ❌ Redux
- ❌ Context API
- ❌ Zustand
- ❌ MobX

All state is **local component state** using React hooks.

---

### Presentation Page State

**File**: `app/presentation/page.tsx`

**State Variables**:

```typescript
const [slides, setSlides] = useState<Slide[]>([]);
const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
const [persona, setPersona] = useState<Persona>('all');
const [showNotes, setShowNotes] = useState(false);
const [initialSlideSet, setInitialSlideSet] = useState(false);
```

**State Flow**:

1. **On Mount**: Load slides from client loader
   ```typescript
   useEffect(() => {
     const loadSlides = async () => {
       try {
         const loadedSlides = await getAllSlidesClient();
         setSlides(loadedSlides);
       } catch (error) {
         console.error('Error loading slides:', error);
       }
     };
     loadSlides();
   }, []);
   ```

2. **URL Sync**: Read `?slide=N` param and set initial slide
   ```typescript
   useEffect(() => {
     if (slides.length > 0 && !initialSlideSet) {
       const slideParam = searchParams.get('slide');
       if (slideParam) {
         const slideNumber = parseInt(slideParam, 10);
         if (!isNaN(slideNumber) && slideNumber >= 1 && slideNumber <= slides.length) {
           setCurrentSlideIndex(slideNumber - 1); // Convert to 0-index
         }
       }
       setInitialSlideSet(true);
     }
   }, [slides.length, searchParams, initialSlideSet]);
   ```

3. **Navigation**: Update currentSlideIndex via handlers
   ```typescript
   const handleNext = () => {
     if (currentSlideIndex < slides.length - 1) {
       setCurrentSlideIndex(prev => prev + 1);
     }
   };

   const handlePrevious = () => {
     if (currentSlideIndex > 0) {
       setCurrentSlideIndex(prev => prev - 1);
     }
   };
   ```

4. **Persona Selection**: User changes persona dropdown
   ```typescript
   <PersonaSelector
     persona={persona}
     onChange={setPersona}
   />
   ```

5. **Props Drilling**: Pass state down to children
   ```typescript
   <Slide slide={currentSlide} persona={persona} />
   <Navigation
     currentSlideIndex={currentSlideIndex}
     totalSlides={slides.length}
     onNext={handleNext}
     onPrevious={handlePrevious}
   />
   ```

---

### State Persistence

**What is NOT persisted**:
- ❌ Current slide (lost on page reload unless in URL)
- ❌ Persona selection (resets to 'all')
- ❌ Presenter notes state (open/closed)

**What IS persisted**:
- ✅ Slide data (cached in memory during session)

**Future Enhancements**:
- Use `localStorage` to persist persona
- Add URL param `?persona=devops` for sharing
- Save progress in localStorage

---

## Keyboard & Gesture Events

### Keyboard Navigation

**File**: `components/ui/Navigation.tsx`

**Implementation**:
```typescript
useEffect(() => {
  const handleKeyPress = (event: KeyboardEvent) => {
    if (event.key === 'ArrowRight' || event.key === ' ') {
      onNext();
    } else if (event.key === 'ArrowLeft') {
      onPrevious();
    } else if (event.key === 'p' || event.key === 'P') {
      // Toggle presenter notes (handled in parent)
    }
  };

  window.addEventListener('keydown', handleKeyPress);
  return () => window.removeEventListener('keydown', handleKeyPress);
}, [onNext, onPrevious]);
```

**Shortcuts**:
- `→` or `Space`: Next slide
- `←`: Previous slide
- `P`: Toggle presenter notes

---

### Touch Gestures (Mobile)

**Implementation**: Custom swipe detection

```typescript
const [touchStart, setTouchStart] = useState<number | null>(null);
const [touchEnd, setTouchEnd] = useState<number | null>(null);

const handleTouchStart = (e: TouchEvent) => {
  setTouchStart(e.targetTouches[0].clientX);
};

const handleTouchMove = (e: TouchEvent) => {
  setTouchEnd(e.targetTouches[0].clientX);
};

const handleTouchEnd = () => {
  if (!touchStart || !touchEnd) return;

  const distance = touchStart - touchEnd;
  const isLeftSwipe = distance > 50;
  const isRightSwipe = distance < -50;

  if (isLeftSwipe) onNext();
  if (isRightSwipe) onPrevious();
};
```

**Gestures**:
- Swipe left: Next slide
- Swipe right: Previous slide

---

## URL-Based Navigation

### Deep Linking

**Pattern**: `/presentation?slide=15`

**Implementation**:
```typescript
const searchParams = useSearchParams();
const slideParam = searchParams.get('slide');

useEffect(() => {
  if (slideParam) {
    const slideNumber = parseInt(slideParam, 10);
    setCurrentSlideIndex(slideNumber - 1);
  }
}, [slideParam]);
```

**Usage**:
- Share specific slide: `/presentation?slide=12`
- Direct navigation from catalog
- Bookmark support

**Limitation**: URL does not update when navigating (one-way sync)

**Future Enhancement**: Use `router.push()` to update URL on slide change

---

## Data Flow Patterns Summary

### Build Time
```
Markdown Files
  ↓ (read by Node.js)
lib/slides.ts
  ↓ (parse with gray-matter)
Slide[] objects
  ↓ (write to file)
public/slides.json
```

### Runtime
```
User visits /presentation
  ↓ (React renders)
Page component mounts
  ↓ (useEffect triggers)
lib/slides-client.ts
  ↓ (fetch JSON)
public/slides.json
  ↓ (parse response)
Slide[] in state
  ↓ (render)
Slide component
  ↓ (switch statement)
Special slide component
```

### Interaction Flow
```
User presses → key
  ↓ (keyboard event)
Navigation component
  ↓ (calls onNext prop)
Presentation page
  ↓ (setCurrentSlideIndex(n + 1))
State updates
  ↓ (React re-renders)
Slide component
  ↓ (Framer Motion animates)
New slide appears
```

---

## Type Safety

### Type Definitions

**File**: `lib/types.ts`

```typescript
export type Persona = 'sysadmin' | 'devops' | 'developer' | 'platform' | 'all';

export interface SlideContent {
  title: string;
  content: string;
  speakerNotes?: string;
  visualDescription?: string;
  references?: string;
}

export interface Slide {
  id: string;
  number: number;
  title: string;
  content: SlideContent;
  part?: string;
  persona?: Persona[];
}

export interface SlideMetadata {
  totalSlides: number;
  parts: { name: string; start: number; end: number }[];
}

export interface PresentationState {
  currentSlide: number;
  persona: Persona;
  showNotes: boolean;
  showReferences: boolean;
  progress: number;
}
```

### Type Flow
```
Markdown file
  ↓ (parsed by gray-matter)
any (raw data)
  ↓ (mapped to)
Slide interface
  ↓ (returned as)
Slide[] array
  ↓ (consumed by)
React components (typed props)
```

---

## Caching Strategy

### In-Memory Cache

**Location**: `lib/slides-client.ts`

**Implementation**:
```typescript
let cachedData: Slide[] | null = null;

export async function getAllSlidesClient(): Promise<Slide[]> {
  if (cachedData) return cachedData; // ✅ Return cached
  // ... fetch and cache
  return cachedData;
}
```

**Scope**: Module-level (shared across all imports)

**Lifetime**: Browser tab session

**Invalidation**: None (refresh page to clear)

---

### Browser Cache

**File**: `public/slides.json`

**Headers** (served by GitHub Pages):
- `Cache-Control: max-age=600` (10 minutes)
- Browsers cache for 10 minutes
- Subsequent visits load from browser cache

---

## Error Handling

### Data Loading Errors

```typescript
try {
  const loadedSlides = await getAllSlidesClient();
  setSlides(loadedSlides);
} catch (error) {
  console.error('Error loading slides:', error);
  // Future: Show error UI
}
```

**Current Behavior**:
- Logs error to console
- No user-facing error message
- Application may show empty state

**Future Enhancement**:
- Add error boundary
- Show retry button
- Fallback to local cached data

---

## Related Files

| File | Purpose |
|------|---------|
| `lib/slides.ts` | Server-side data loader (build time) |
| `lib/slides-client.ts` | Client-side data loader (runtime) |
| `lib/types.ts` | Type definitions |
| `scripts/generate-slides.mjs` | Build script |
| `app/presentation/page.tsx` | Main presentation page with state |
| `ADR 0001` | Static Export decision |
| `ADR 0002` | Dual Data Loading decision |

---

This data flow is **as-built** from the current codebase. Future features (blog, podcasts) should follow similar patterns.
